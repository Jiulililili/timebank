<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>è¿˜å‰©å‡ å°æ—¶ï¼Ÿ</title>

<!-- ====== PWA å¿…é¡» ====== -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1e3c72">
<link rel="apple-touch-icon" href="/icons/clock-192.png">

<style>
body{
    font-family: "Microsoft YaHei";
    background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    margin:0;
}

.container{
    max-width: 900px;
    margin:0 auto;
    background:white;
    min-height:100vh;
    padding:15px;
}

.header{
    background:#1e3c72;
    color:white;
    padding:12px;
    text-align:center;
    font-size:20px;
    border-radius:8px;
}

.section{
    border:1px solid #ddd;
    padding:15px;
    margin:10px 0;
    border-radius:10px;
}

.flex{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
}

.card{
    flex:1;
    padding:12px;
    border-radius:10px;
    text-align:center;
    min-width:150px;
}

.balance-card{ background:#e8f5e9; }
.debt-card{ background:#ffebee; }

button{
    padding:10px;
    border:none;
    border-radius:8px;
    color:white;
    margin:5px 0;
}

.deposit{ background:#2ecc71; }
.withdraw{ background:#e74c3c; }
.loan{ background:#f39c12; }
.repay{ background:#8e44ad; }
.save{ background:#3498db; }
.reset{ background:#95a5a6; }

table{
    width:100%;
    border-collapse: collapse;
}
th,td{
    border:1px solid #ddd;
    padding:6px;
    text-align:center;
    font-size:14px;
}

canvas{
    width:100%;
    height:260px;
    border:1px solid #ddd;
}
</style>
</head>

<body>
<div class="container">

<div class="header">ğŸ¦ è¿˜å‰©å‡ å°æ—¶ï¼Ÿ</div>

<div class="section flex">
  <div class="card balance-card">
    <h3>å½“å‰ä½™é¢</h3>
    <h2>Â¥ <span id="balance">0.00</span></h2>
  </div>
  <div class="card debt-card">
    <h3>å‰©ä½™æ¬ æ¬¾</h3>
    <h2>Â¥ <span id="debt">0.00</span></h2>
  </div>
</div>

<div class="section">
<h3>ğŸ’° å­˜å–æ¬¾</h3>
<input type="number" id="amount" placeholder="è¾“å…¥é‡‘é¢"><br>
<button class="deposit" onclick="deposit()">å­˜å…¥</button>
<button class="withdraw" onclick="withdraw()">å–å‡º</button>
</div>

<div class="section">
<h3>ğŸ¦ ç”³è¯·è´·æ¬¾</h3>
<input type="number" id="loanAmount" placeholder="è´·æ¬¾é‡‘é¢"><br>
<input type="number" id="interest" placeholder="å¹´åˆ©ç‡ %"><br>
<input type="number" id="years" placeholder="è´·æ¬¾å¹´æ•°"><br><br>
<button class="loan" onclick="takeLoan()">ç”³è¯·è´·æ¬¾</button>
<p id="loanInfo"></p>
</div>

<div class="section">
<h3>ğŸ’¸ è¿˜æ¬¾</h3>
<input type="number" id="repayAmount" placeholder="è¿˜æ¬¾é‡‘é¢"><br>
<button class="repay" onclick="repay()">ç«‹å³è¿˜æ¬¾</button>
</div>

<div class="section">
<h3>ğŸ“… è¿˜æ¬¾åˆ†æœŸè¡¨</h3>
<table>
<tr><th>æœŸæ•°</th><th>æ¯æœˆåº”è¿˜</th><th>æ€»æœŸæ•°</th></tr>
<tbody id="schedule"></tbody>
</table>
</div>

<div class="section">
<h3>ğŸ“ˆ ä½™é¢æ›²çº¿</h3>
<canvas id="chart"></canvas>
</div>

<div class="section">
<h3>ğŸ“œ äº¤æ˜“è®°å½•</h3>
<table>
<tr>
<th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>ä½™é¢</th><th>å‰©ä½™æ¬ æ¬¾</th>
</tr>
<tbody id="history"></tbody>
</table>
</div>

<div class="section">
<button class="save" onclick="saveData()">ä¿å­˜æ•°æ®</button>
<button class="reset" onclick="resetData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
</div>

</div>

<script>
// ======== æ•°æ®ï¼ˆäº‘ç«¯åŒæ ·åªåœ¨æµè§ˆå™¨æœ¬åœ°ä¿å­˜ï¼‰ ========
let balance = parseFloat(localStorage.getItem("balance") || 0);
let debt = parseFloat(localStorage.getItem("debt") || 0);
let history = JSON.parse(localStorage.getItem("history") || "[]");
let schedule = JSON.parse(localStorage.getItem("schedule") || "[]");

// ======== UI ========
function updateUI(){
    document.getElementById("balance").innerText = balance.toFixed(2);
    document.getElementById("debt").innerText = debt.toFixed(2);

    let h = document.getElementById("history");
    h.innerHTML = "";
    history.forEach(r=>{
        h.innerHTML += `
        <tr>
        <td>${r.time}</td>
        <td>${r.type}</td>
        <td>Â¥${r.amount}</td>
        <td>Â¥${r.balance}</td>
        <td>Â¥${r.debt}</td>
        </tr>`;
    });

    let s = document.getElementById("schedule");
    s.innerHTML = "";
    schedule.forEach(r=>{
        s.innerHTML += `
        <tr>
        <td>${r.month}</td>
        <td>Â¥${r.monthPay}</td>
        <td>${r.totalMonths}</td>
        </tr>`;
    });

    drawChart();
}

function addRecord(type, amount){
    history.push({
        time: new Date().toLocaleString(),
        type: type,
        amount: amount.toFixed(2),
        balance: balance.toFixed(2),
        debt: debt.toFixed(2)
    });
}

// ======== åŠŸèƒ½ ========
function deposit(){
    let amt = parseFloat(amount.value);
    if(isNaN(amt) || amt<=0){ alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢"); return; }
    balance += amt;
    addRecord("å­˜å…¥", amt);
    updateUI();
}

function withdraw(){
    let amt = parseFloat(amount.value);
    if(isNaN(amt) || amt<=0){ alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢"); return; }
    if(amt > balance){ alert("ä½™é¢ä¸è¶³"); return; }
    balance -= amt;
    addRecord("å–å‡º", amt);
    updateUI();
}

function takeLoan(){
    let L = parseFloat(loanAmount.value);
    let r = parseFloat(interest.value)/100;
    let n = parseInt(years.value);

    if(isNaN(L)||isNaN(r)||isNaN(n)){ alert("è¯·å¡«å†™å®Œæ•´"); return; }

    let totalInterest = L*r*n;
    let totalRepay = L + totalInterest;
    let totalMonths = n*12;
    let monthPay = totalRepay/totalMonths;

    balance += L;
    debt += totalRepay;

    addRecord("è´·æ¬¾åˆ°è´¦", L);

    schedule = [];
    for(let i=1;i<=totalMonths;i++){
        schedule.push({
            month:i,
            monthPay:monthPay.toFixed(2),
            totalMonths:totalMonths
        });
    }

    loanInfo.innerText =
    `åº”è¿˜æ€»é¢ Â¥${totalRepay.toFixed(2)}ï¼Œæ¯æœˆ Â¥${monthPay.toFixed(2)}ï¼Œå…± ${totalMonths} æœŸ`;

    updateUI();
}

function repay(){
    let amt = parseFloat(repayAmount.value);
    if(isNaN(amt)||amt<=0){ alert("é‡‘é¢æ— æ•ˆ"); return; }
    if(amt>balance){ alert("ä½™é¢ä¸è¶³"); return; }
    if(debt<=0){ alert("æ— æ¬ æ¬¾"); return; }

    balance -= amt;
    debt = Math.max(0, debt-amt);
    addRecord("è¿˜æ¬¾", amt);
    updateUI();
}

// ======== æ›²çº¿ ========
function drawChart(){
    let c=document.getElementById("chart");
    let ctx=c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    if(history.length<1) return;

    let b=history.map(r=>parseFloat(r.balance));
    let max=Math.max(...b);
    let min=Math.min(...b);
    let step=c.width/(b.length-1||1);

    ctx.beginPath();
    b.forEach((v,i)=>{
        let y=c.height-((v-min)/(max-min||1))*c.height;
        let x=i*step;
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    });
    ctx.strokeStyle="#1e3c72";
    ctx.stroke();
}

// ======== ä¿å­˜ ========
function saveData(){
    localStorage.setItem("balance", balance);
    localStorage.setItem("debt", debt);
    localStorage.setItem("history", JSON.stringify(history));
    localStorage.setItem("schedule", JSON.stringify(schedule));
    alert("å·²ä¿å­˜");
}

function resetData(){
    if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")){
        localStorage.clear();
        balance=0; debt=0; history=[]; schedule=[];
        updateUI();
    }
}

updateUI();

// ====== æ³¨å†Œ PWA Service Worker ======
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js');
}
</script>
</body>
</html>
